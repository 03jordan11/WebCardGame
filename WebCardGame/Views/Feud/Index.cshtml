@{
    ViewData["Title"] = "Home Page";
}
@{
    Layout = "_Layout";
}
@model FeudViewModel

@using WebCardGame.Domains;
<h1 id="title" hidden>Feud</h1>
<div id="startSection">
    <div id="startPage" class="row">
        <div id="welcomeMessage" class="col-lg-6">
            <h2 style="text-align: center;">
                Welcome to Feud, a card game about taking all of your opponents cards!
                If You don't know how to play click the rules.
                If you do, select your difficulty and press start
            </h2>
        </div>
    </div>

    <div id="startButtons" class="row">
        <div class="col-lg-6">
            <select id="difficultySelect">
                <option value="Normal">Normal</option>
                <option value="Hard">Hard</option>
            </select>
            <button id="startButton" class="btn btn-secondary btn-lg" id="startGame">START</button>
        </div>
    </div>
</div>


<div hidden id="gameContainer" style="width:1000px; height:700px; border:2px solid gray; position:center">
    <div id="centerBoard" style="position:relative; top: 210px; left: 360px">
            <div class="centerCards" id="player1Selected"></div>
            <div class="centerCards" id="bot1Selected" ></div>
    </div>
    <div class="row" id="playerHand" style="position:relative; top: 280px; left: 260px">
        <div class="col-sm-2 hand" card-value="Gray_back" id="playerCard1" ></div>
        <div class="col-sm-2 hand" card-value="Gray_back" id="playerCard2" ></div>
        <div class="col-sm-2 hand" card-value="Gray_back" id="playerCard3" ></div>
        <div class="col-sm-2 hand" card-value="Gray_back" id="playerCard4" ></div>
        <div class="col-sm-2 hand" card-value="Gray_back" id="playerCard5" ></div>
        
        <div class="col-lg-1" id="playerDraw" style="width:50px; height:70px; padding: 1px; border:1px dotted gray; position:relative; left: 20px; bottom:40px">draw</div>
        <div class="col-lg-1" id="playerDiscard" style="width:50px; height:70px; padding: 1px; border:1px dotted gray; position:relative; right: 30px; top:40px">discard</div>
    </div>
   

</div>
 
<style>

    #startPage {
        position: fixed;
        left: 450px;
        top: 150px;
        width: 800px;
        background-color: brown;
        border-radius: 10px;
    }
    #startButton{
        position: relative;
        left: 160px;
        top: 30px;
    }
    #startButtons{
        position: fixed;
        left: 600px;
        top: 300px;
        width: 600px;
        height: 100px;
        background-color: burlywood;
        border-radius: 10px;
    }
    #welcomeMessage {
        background-image: url("/images/greenfelt.png");
        border-radius: 10px;
        height: 150px;
        width: 900px;
        border: 1px ridge;
    }
    .hand {
        width: 68px;
        height: 100px;
        padding: 1px;
        border: 1px solid black;
        border-radius: 10px;
        background-size: contain;
    }
    #playerDraw {
        text-decoration-style: double;
        text-decoration-color: black;
        color: orangered;
        font-size: 25px;
        font-weight: bold;
        font-family: Calibri;
        font: bold;
        text-align: center;
        background-size: contain;
        background-image: url("images/cards/Gray_back.png");
    }
    #playerDiscard {
        color: orangered;
        font-size: 25px;
        font-weight: bold;
        font-family: Calibri;
        font: bold;
        text-align: center;
        background-size: contain;
        background-image: url("images/cards/Gray_back.png");
    }
   
    .centerCards {
        width: 68px;
        height: 100px;
        padding: 1px;
        border: 1px solid black;
        border-radius: 10px;
        background-image: url("/images/cards/Gray_back.png");
    }
    #gameContainer{
        position: center;
        background-image: url("images/greenfelt.png");
    }
</style>

@section Scripts{


<script type="text/javascript">
   
    var deck = [];
    var temp;

    var player = [];
    var playerHand = [];
    var playerDiscard = [];

    var bot1 = [];
    var bot1Hand = [];
    var bot1Discard = [];

    var bot2 = [];
    var bot3 = [];
    //
    
    //Creating Deck from View Model
    function CreateDeck() {
        @foreach(var item in Model.FeudGame.DrawDeck.Cards)
        {
            @:temp = @Html.Raw(Json.Serialize(item));
            @:deck.push(temp);
        }
    }


    function sleep(milliseconds) {
        var start = new Date().getTime();
        for (var i = 0; i < 1e7; i++) {
            if ((new Date().getTime() - start) > milliseconds) {
                break;
            }
        }
    }

    //Ditributes cards to all players
    //TODO give an argument for num of players
    function DistributeCards() {
        //conditionally check players first
        //THIS DISTRIBUTES CARDS TO ALL PLAYERS
        var x = deck.length
        for (i = 0; i < x; i++) {
            player.push(deck.pop());
            i++;
            bot1.push(deck.pop());
        }
    }

    //Draws card from players deck to his hand
    //TODO give arguemtns for checking hand size and drawing acoordingly
    function PlayerDraw(firstTurn, person) {
        debugger;
        if (person === "player") {
            if (firstTurn === false) {
                playerHand.push(player.pop());
            }
            else {
                for (i = 0; i < 5; i++)
                    playerHand.push(player.pop());
            }
        }
        else if (person === "bot1") {
            if (firstTurn === false) {
                bot1Hand.push(bot1.pop());
            }
            else {
                for (i = 0; i < 5; i++)
                    bot1Hand.push(bot1.pop());
            }
        }
        
        //THIS DRAWS CARDS FROM PLAYERS DECK TO HIS HAND
        AppendCardImages();
        $("#playerDiscard").text(playerDiscard.length);
        $("#playerDraw").text(player.length);
    }

    function checkValue(card) {
        debugger;
        var temp = card;
        if (card === 1 || card === "1")
            temp = "A";
        else if (card === 11 || card === "11")
            temp = "J";
        else if (card === 12 || card === "12")
            temp = "Q"
        else if (card === 13 || card === "13")
            temp = "K"
        return temp;
    }

    function AppendCardImages() {
        //Might have to toString()

        $("#playerCard1").attr("card-value",playerHand[0].value + playerHand[0].suit.substring(0, 1));
        $("#playerCard2").attr("card-value",playerHand[1].value + playerHand[1].suit.substring(0, 1));
        $("#playerCard3").attr("card-value",playerHand[2].value + playerHand[2].suit.substring(0, 1));
        $("#playerCard4").attr("card-value",playerHand[3].value + playerHand[3].suit.substring(0, 1));
        $("#playerCard5").attr("card-value",playerHand[4].value + playerHand[4].suit.substring(0, 1));

        $("#playerCard1").css("background-image", "url('images/cards/" + checkValue(playerHand[0].value) + playerHand[0].suit.substring(0, 1) + ".png')");
        $("#playerCard2").css("background-image", "url('images/cards/" + checkValue(playerHand[1].value) + playerHand[1].suit.substring(0, 1) + ".png')");
        $("#playerCard3").css("background-image", "url('images/cards/" + checkValue(playerHand[2].value) + playerHand[2].suit.substring(0, 1) + ".png')");
        $("#playerCard4").css("background-image", "url('images/cards/" + checkValue(playerHand[3].value) + playerHand[3].suit.substring(0, 1) + ".png')");
        $("#playerCard5").css("background-image", "url('images/cards/" + checkValue(playerHand[4].value) + playerHand[4].suit.substring(0, 1) + ".png')");
    }


    //Bot Picks card
    //TODO add logic to pick based on others, and add argument for difficulty level
    function BotPick() {
        if (bot1Hand.length > 0)
            return bot1Hand.pop();
    }

    //Returns number to find card in array from formated string 'card'
    function FindCardInDeck(deck, card) {
        for (i = 0; i < deck.length; i++){
            if(deck[i].suit.substring(0, 1) === card.slice(-1) && deck[i].value.toString() === card.slice(0, -1))
                return i;
        }
        return i;
    }

    function endTurn(winner, cards) {
        debugger;
        for (item in cards) {
            winner.push(cards[item]);
        }
        if(player.length>0)
            PlayerDraw(false, "player");
        if (playerHand.length === 0) { //if player has no more cards in hand, reset from discard
            if (playerDiscard.length === 0) {
                alert("You lost");
                //end game, ask to play again
            }
            player = playerDiscard;
            playerDiscard = [];
            PlayerDraw(true, "player");
        }

        if(bot1.length>0)
            PlayerDraw(false, "bot1");
        if (bot1Hand.length === 0) {
            if (bot1Discard.length === 0) {
                //end game, you win
            }
            bot1 = bot1Discard;
            bot1Discard = [];
            PlayerDraw(true, "bot1");
        }
    }

    $(document).ready(function () {
        
        //creates inital deck to play with
        CreateDeck();
        //gives cards to players
        DistributeCards();
        //player and bot draws, set to true so he draws for first turn
        PlayerDraw(true, "player");
        PlayerDraw(true, "bot1");
        

        $(".hand").on('click', function () {
            //gets value associated with card clicked on
            var playerDisplay = $(this).attr("card-value");
            //gets numerical position related to deck for what card was clicked on, then removes that from the players hand and sets the center to it
            var handPosition = FindCardInDeck(playerHand, playerDisplay);
            var playerVal = playerHand[handPosition];
            playerHand.splice(handPosition, 1);
            var botPick = BotPick();
            $(this).css("background-image", "");

            $("#bot1Selected").attr("card-value", botPick.value + botPick.suit.substring(0, 1));
            $("#bot1Selected").css("background-image", "url('images/cards/" + checkValue(botPick.value) + botPick.suit.substring(0, 1) + ".png')");


            $("#player1Selected").attr("card-value", playerDisplay);
            $("#player1Selected").css("background-image", "url('images/cards/" + checkValue(playerDisplay.slice(0, -1)) + playerDisplay[playerDisplay.length - 1] + ".png')");
            
            if (playerVal.value > botPick.value) {
                endTurn(playerDiscard, [playerVal, botPick]);
            }
            else {
                endTurn(bot1Discard, [playerVal, botPick]);
            }
            $("#playerDiscard").text(playerDiscard.length);
            $("#playerDraw").text(player.length);
            if (playerVal.value > botPick.value) {
                setTimeout(function () {
                    alert("Your Card is Higher");
                }, 0);
            }
            else {
                setTimeout(function () {
                    alert("Bots Card is Higher");
                }, 0);
            }

            //(function () {
            //    $("#bot1Selected").attr("card-value", botPick.value + botPick.suit.substring(0, 1));
            //    $("#bot1Selected").css("background-image", "url('images/cards/" + checkValue(botPick.value) + botPick.suit.substring(0, 1) + ".png')");


            //    $("#player1Selected").attr("card-value", playerDisplay);
            //    $("#player1Selected").css("background-image", "url('images/cards/" + checkValue(playerDisplay.slice(0, -1)) + playerDisplay[playerDisplay.length - 1] + ".png')");
            //})();        
            //$.when(function () {
                
            //}).then(function () {
            //    if (playerVal.value > botPick.value) {
            //        //sleep(500);
            //        alert("Your Card is Higher");
            //    }
            //    else {
            //        //sleep(500);
            //        alert("Bot's Card is Higher");
            //    }
            //}).then(function () {
            //    if (playerVal.value > botPick.value) {
            //        endTurn(playerDiscard, [playerVal, botPick]);
            //    }
            //    else {
            //        endTurn(bot1Discard, [playerVal, botPick]);
            //    }
            //    }).then(function () {
            //        $("#playerDiscard").text(playerDiscard.length);
            //        $("#playerDraw").text(player.length);
            //    });
        });

        $("#startButton").on("click", function () {
            $("#startSection").hide();
            $("#title").show();
            $("#gameContainer").show();
        });

        $(".hand").mouseover(function () {
            $(this).css('transform', "scale(1.3)");
        });
        $(".hand").mouseleave(function () {
            $(this).css('transform', "scale(1.0)");
        });
    });





</script>
    }